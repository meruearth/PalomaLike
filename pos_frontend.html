<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>POS System</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: #f5f5f5;
                color: #333;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                background: #2c3e50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .header h1 {
                font-size: 24px;
            }

            .user-info {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.3s;
            }

            .btn-primary {
                background: #3498db;
                color: white;
            }

            .btn-primary:hover {
                background: #2980b9;
            }

            .btn-success {
                background: #27ae60;
                color: white;
            }

            .btn-success:hover {
                background: #219a52;
            }

            .btn-danger {
                background: #e74c3c;
                color: white;
            }

            .btn-danger:hover {
                background: #c0392b;
            }

            .main-content {
                display: grid;
                grid-template-columns: 1fr 1fr 400px;
                gap: 20px;
                min-height: 600px;
            }

            .section {
                background: white;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .section h2 {
                margin-bottom: 15px;
                color: #2c3e50;
                border-bottom: 2px solid #ecf0f1;
                padding-bottom: 10px;
            }

            .tables-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 15px;
            }

            .table-card {
                background: #ecf0f1;
                border: 2px solid #bdc3c7;
                border-radius: 8px;
                padding: 15px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s;
            }

            .table-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .table-card.occupied {
                background: #e8f5e8;
                border-color: #27ae60;
            }

            .table-card.selected {
                background: #dbeafe;
                border-color: #3498db;
            }

            .menu-categories {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                flex-wrap: wrap;
            }

            .category-btn {
                padding: 8px 16px;
                border: 1px solid #ddd;
                background: white;
                border-radius: 20px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .category-btn.active {
                background: #3498db;
                color: white;
                border-color: #3498db;
            }

            .menu-items {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .menu-item {
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .menu-item:hover {
                background: #e9ecef;
                transform: translateY(-2px);
            }

            .menu-item h3 {
                margin-bottom: 5px;
                color: #2c3e50;
            }

            .menu-item .price {
                font-size: 18px;
                font-weight: bold;
                color: #27ae60;
            }

            .order-summary {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
            }

            .order-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #e9ecef;
            }

            .order-item:last-child {
                border-bottom: none;
            }

            .order-total {
                font-size: 20px;
                font-weight: bold;
                color: #2c3e50;
                text-align: right;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 2px solid #3498db;
            }

            .login-form {
                max-width: 400px;
                margin: 100px auto;
                background: white;
                padding: 40px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                color: #2c3e50;
                font-weight: bold;
            }

            .form-group input {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 16px;
            }

            .hidden {
                display: none;
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat-card {
                background: #3498db;
                color: white;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
            }

            .stat-card h3 {
                font-size: 24px;
                margin-bottom: 5px;
            }

            .payment-methods {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-top: 15px;
            }

            @media (max-width: 768px) {
                .main-content {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div id="loginForm" class="login-form">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50">
                –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
            </h2>
            <div class="form-group">
                <label for="pin">PIN –∫–æ–¥:</label>
                <input type="password" id="pin" placeholder="–í–≤–µ–¥–∏—Ç–µ PIN –∫–æ–¥" />
            </div>
            <button
                class="btn btn-primary"
                style="width: 100%"
                onclick="login()"
            >
                –í–æ–π—Ç–∏
            </button>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="mainApp" class="hidden">
            <div class="header">
                <h1>üçΩÔ∏è POS System</h1>
                <div class="user-info">
                    <span id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    <button class="btn btn-danger" onclick="logout()">
                        –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>

            <div class="container">
                <div class="stats" id="stats">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div class="main-content">
                    <!-- –°—Ç–æ–ª—ã -->
                    <div class="section">
                        <h2>üìç –°—Ç–æ–ª—ã</h2>
                        <div class="tables-grid" id="tablesGrid">
                            <!-- –°—Ç–æ–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>

                    <!-- –ú–µ–Ω—é -->
                    <div class="section">
                        <h2>üçï –ú–µ–Ω—é</h2>
                        <div class="menu-categories" id="menuCategories">
                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <div class="menu-items" id="menuItems">
                            <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>

                    <!-- –ó–∞–∫–∞–∑ -->
                    <div class="section">
                        <h2>üìã –ó–∞–∫–∞–∑</h2>
                        <div id="tableInfo" class="hidden">
                            <p>
                                <strong>–°—Ç–æ–ª:</strong>
                                <span id="selectedTableName"></span>
                            </p>
                            <hr style="margin: 10px 0" />
                        </div>
                        <div class="order-summary">
                            <div id="orderItems">
                                <p style="text-align: center; color: #95a5a6">
                                    –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã
                                </p>
                            </div>
                            <div class="order-total">
                                –ò—Ç–æ–≥–æ: $<span id="orderTotal">0.00</span>
                            </div>
                        </div>
                        <div class="payment-methods">
                            <button
                                class="btn btn-success"
                                onclick="processPayment('cash')"
                            >
                                üíµ –ù–∞–ª–∏—á–Ω—ã–µ
                            </button>
                            <button
                                class="btn btn-success"
                                onclick="processPayment('card')"
                            >
                                üí≥ –ö–∞—Ä—Ç–∞
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            let currentUser = null;
            let selectedTable = null;
            let currentOrder = [];
            let categories = [];
            let items = [];
            let tables = [];

            // API —Ñ—É–Ω–∫—Ü–∏–∏
            async function apiCall(endpoint, options = {}) {
                try {
                    const response = await fetch(`/api${endpoint}`, {
                        headers: {
                            "Content-Type": "application/json",
                            ...options.headers,
                        },
                        ...options,
                    });
                    return await response.json();
                } catch (error) {
                    console.error("API Error:", error);
                    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
                }
            }

            // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            async function login() {
                const pin = document.getElementById("pin").value;
                if (!pin) {
                    alert("–í–≤–µ–¥–∏—Ç–µ PIN –∫–æ–¥");
                    return;
                }

                const result = await apiCall("/auth/login", {
                    method: "POST",
                    body: JSON.stringify({ pin }),
                });

                if (result && result.success) {
                    currentUser = result.employee;
                    document.getElementById("userName").textContent =
                        currentUser.name;
                    document
                        .getElementById("loginForm")
                        .classList.add("hidden");
                    document
                        .getElementById("mainApp")
                        .classList.remove("hidden");
                    await loadData();
                } else {
                    alert("–ù–µ–≤–µ—Ä–Ω—ã–π PIN –∫–æ–¥");
                }
            }

            function logout() {
                currentUser = null;
                selectedTable = null;
                currentOrder = [];
                document.getElementById("loginForm").classList.remove("hidden");
                document.getElementById("mainApp").classList.add("hidden");
                document.getElementById("pin").value = "";
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            async function loadData() {
                await Promise.all([
                    loadStats(),
                    loadTables(),
                    loadCategories(),
                    loadItems(),
                ]);
            }

            async function loadStats() {
                const stats = await apiCall("/stats");
                if (stats) {
                    document.getElementById("stats").innerHTML = `
                    <div class="stat-card">
                        <h3>${stats.totalOrders}</h3>
                        <p>–ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è</p>
                    </div>
                    <div class="stat-card">
                        <h3>$${stats.totalSales.toFixed(2)}</h3>
                        <p>–ü—Ä–æ–¥–∞–∂</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.openOrders}</h3>
                        <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.occupiedTables}</h3>
                        <p>–ó–∞–Ω—è—Ç–æ —Å—Ç–æ–ª–æ–≤</p>
                    </div>
                `;
                }
            }

            async function loadTables() {
                tables = await apiCall("/tables");
                if (tables) {
                    const tablesGrid = document.getElementById("tablesGrid");
                    tablesGrid.innerHTML = tables
                        .map(
                            (table) => `
                    <div class="table-card ${table.status === "occupied" ? "occupied" : ""}" 
                         onclick="selectTable(${table.id})">
                        <h3>${table.name}</h3>
                        <p>${table.seats} –º–µ—Å—Ç–∞</p>
                        <p>${table.status === "occupied" ? "üî¥ –ó–∞–Ω—è—Ç" : "üü¢ –°–≤–æ–±–æ–¥–µ–Ω"}</p>
                    </div>
                `,
                        )
                        .join("");
                }
            }

            async function loadCategories() {
                categories = await apiCall("/categories");
                if (categories) {
                    const categoriesContainer =
                        document.getElementById("menuCategories");
                    categoriesContainer.innerHTML = categories
                        .map(
                            (cat) => `
                    <button class="category-btn" onclick="selectCategory(${cat.id})">${cat.name}</button>
                `,
                        )
                        .join("");
                }
            }

            async function loadItems(categoryId = null) {
                const endpoint = categoryId
                    ? `/items?categoryId=${categoryId}`
                    : "/items";
                items = await apiCall(endpoint);
                if (items) {
                    const itemsContainer = document.getElementById("menuItems");
                    itemsContainer.innerHTML = items
                        .map(
                            (item) => `
                    <div class="menu-item" onclick="addToOrder(${item.id})">
                        <h3>${item.name}</h3>
                        <p class="price">$${item.price.toFixed(2)}</p>
                    </div>
                `,
                        )
                        .join("");
                }
            }

            // –í—ã–±–æ—Ä —Å—Ç–æ–ª–∞
            function selectTable(tableId) {
                selectedTable = tables.find((t) => t.id === tableId);
                if (selectedTable) {
                    // –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–∑—É–∞–ª
                    document.querySelectorAll(".table-card").forEach((card) => {
                        card.classList.remove("selected");
                    });
                    event.target.classList.add("selected");

                    // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–æ–ª–µ
                    document
                        .getElementById("tableInfo")
                        .classList.remove("hidden");
                    document.getElementById("selectedTableName").textContent =
                        selectedTable.name;
                }
            }

            // –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            function selectCategory(categoryId) {
                // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                document.querySelectorAll(".category-btn").forEach((btn) => {
                    btn.classList.remove("active");
                });
                event.target.classList.add("active");

                // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                loadItems(categoryId);
            }

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑
            function addToOrder(itemId) {
                if (!selectedTable) {
                    alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª");
                    return;
                }

                const item = items.find((i) => i.id === itemId);
                if (item) {
                    const existingItem = currentOrder.find(
                        (orderItem) => orderItem.id === itemId,
                    );
                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        currentOrder.push({
                            ...item,
                            quantity: 1,
                        });
                    }
                    updateOrderDisplay();
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
            function updateOrderDisplay() {
                const orderItemsContainer =
                    document.getElementById("orderItems");
                const orderTotalElement = document.getElementById("orderTotal");

                if (currentOrder.length === 0) {
                    orderItemsContainer.innerHTML =
                        '<p style="text-align: center; color: #95a5a6;">–ó–∞–∫–∞–∑ –ø—É—Å—Ç</p>';
                    orderTotalElement.textContent = "0.00";
                    return;
                }

                let total = 0;
                orderItemsContainer.innerHTML = currentOrder
                    .map((item) => {
                        const itemTotal = item.price * item.quantity;
                        total += itemTotal;
                        return `
                    <div class="order-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>$${item.price.toFixed(2)} √ó ${item.quantity}</small>
                        </div>
                        <div>
                            <button onclick="removeFromOrder(${item.id})" style="background: none; border: none; color: #e74c3c; cursor: pointer;">‚ùå</button>
                            <span style="margin-left: 10px;">$${itemTotal.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                    })
                    .join("");

                orderTotalElement.textContent = total.toFixed(2);
            }

            // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∑–∞–∫–∞–∑–∞
            function removeFromOrder(itemId) {
                const index = currentOrder.findIndex(
                    (item) => item.id === itemId,
                );
                if (index > -1) {
                    if (currentOrder[index].quantity > 1) {
                        currentOrder[index].quantity -= 1;
                    } else {
                        currentOrder.splice(index, 1);
                    }
                    updateOrderDisplay();
                }
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã
            async function processPayment(method) {
                if (!selectedTable || currentOrder.length === 0) {
                    alert("–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑");
                    return;
                }

                const total = currentOrder.reduce(
                    (sum, item) => sum + item.price * item.quantity,
                    0,
                );

                // –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
                const orderData = {
                    tableId: selectedTable.id,
                    employeeId: currentUser.id,
                    items: currentOrder.map((item) => ({
                        id: item.id,
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                    })),
                    total: total,
                };

                const orderResult = await apiCall("/orders", {
                    method: "POST",
                    body: JSON.stringify(orderData),
                });

                if (orderResult && orderResult.success) {
                    // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–ª–∞—Ç–µ–∂
                    const paymentResult = await apiCall(
                        `/orders/${orderResult.orderId}/payment`,
                        {
                            method: "POST",
                            body: JSON.stringify({
                                paymentMethod: method,
                                amount: total,
                            }),
                        },
                    );

                    if (paymentResult && paymentResult.success) {
                        alert(`–ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω! –°—É–º–º–∞: $${total.toFixed(2)}`);

                        // –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑
                        currentOrder = [];
                        selectedTable = null;
                        updateOrderDisplay();
                        document
                            .getElementById("tableInfo")
                            .classList.add("hidden");

                        // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        await loadData();
                    } else {
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞");
                    }
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞");
                }
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.addEventListener("DOMContentLoaded", function () {
                document
                    .getElementById("pin")
                    .addEventListener("keypress", function (e) {
                        if (e.key === "Enter") {
                            login();
                        }
                    });
            });
        </script>
    </body>
</html>
